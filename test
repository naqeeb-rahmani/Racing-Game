import pygame, time
import car_class
import math
import random  # Added for particle effects

#大斯坦制作公司tm
#RTN продакшн

#Day 1: Get atleast 1 car, which should be able to move -done
#Day 2: Create a class for the cars - done
#Day 3: Fix movement - done
#Day 4: Fix collision - work in progress

#SCREEN
SCREEN_WIDTH = 1280
SCREEN_HEIGHT = 720

#screen = (pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT)))

pygame.init()

screen = pygame.display.set_mode((SCREEN_WIDTH, SCREEN_HEIGHT),
pygame.SCALED | pygame.FULLSCREEN)

clock = pygame.time.Clock()
##################################

#TEST BACKGROUND
bg_test = pygame.image.load("base_bana.png")

###################

#TEST BLAST
t_blast_unscaled = pygame.image.load(r"assets\kaboom.png").convert_alpha()
t_blast = pygame.transform.scale(t_blast_unscaled, (int(t_blast_unscaled.get_width() * 0.02), int(t_blast_unscaled.get_height() * 0.02)))

#STATES
game = "running"

# Particles list for explosion effects
particles = []
#############################

#CARS
car_1_sprite = pygame.image.load(r"assets\cars\car_1_top.png").convert_alpha()
car_1 = car_class.Car(SCREEN_WIDTH, SCREEN_HEIGHT, car_1_sprite)

#car_1 = pygame.image.load(r"assets\cars\car_player1.png")

car_1_x = 100
car_1_y = 100
car_speed = 10
########################

pygame.display.set_caption("汽车联盟 (Chinatown)")
pygame.display.update()

# Variable to track if explosion has already been triggered
explosion_triggered = False

while game == "running":
    keys = pygame.key.get_pressed()

    if keys[pygame.K_DOWN] and car_1.car_y < (SCREEN_HEIGHT - 64):
        #car_1.car_y = car_1.car_y + car_1.speed
        pass

    car_1_x_int = int((math.cos(car_1.rad) * car_1.speed) + car_1.car_x)
    car_1_y_int = int((math.sin(car_1.rad) * car_1.speed) + car_1.car_y)
    
    #print(bg_test.get_at((car_1_x_int,car_1_y_int)))
    if keys[pygame.K_UP]:
        if bg_test.get_at((car_1_x_int,car_1_y_int)) != (255,255,255,255):
            car_1.movement()
         #car_1.car_y = car_1.car_y - car_1.speed

    # Check for collision with white border
    if bg_test.get_at((car_1_x_int,car_1_y_int)) == (255,255,255,255):
        car_1.explosion = True
        
        # Create particle explosion (only once when first hitting white)
        if not explosion_triggered:
            explosion_triggered = True
            # Create 50 explosion particles
            for _ in range(50):
                particles.append({
                    'x': car_1.car_x,
                    'y': car_1.car_y,
                    'vx': random.uniform(-4, 4),  # Random horizontal speed
                    'vy': random.uniform(-4, 4),  # Random vertical speed
                    'life': random.randint(20, 40),  # Random life span
                    'color': (  # Random orange/yellow colors
                        random.randint(200, 255),  # Red
                        random.randint(50, 150),   # Green
                        0                          # Blue
                    ),
                    'size': random.randint(2, 5)  # Random size
                })
    else:
        # Reset explosion trigger when car is back on track
        explosion_triggered = False
        car_1.explosion = False

    for event in pygame.event.get():
        if event.type == pygame.KEYDOWN:
            if event.key == pygame.K_RIGHT: car_1.direction = 1
            if event.key == pygame.K_LEFT: car_1.direction = -1
        
        if event.type == pygame.KEYUP:
            if event.key == pygame.K_RIGHT: car_1.direction = 0
            if event.key == pygame.K_LEFT: car_1.direction = 0

        if event.type == pygame.QUIT:
            game = "not running"
    
    # Update particles
    for p in particles[:]:  # Use [:] to iterate over a copy
        p['x'] += p['vx']
        p['y'] += p['vy']
        p['life'] -= 1
        
        # Remove dead particles
        if p['life'] <= 0:
            particles.remove(p)
    
    car_1.update()
    
    screen.fill((0,0,0,))
    #test
    screen.blit(bg_test, (0,0))
    
    #################
    # Draw particles (behind everything else)
    for p in particles:
        pygame.draw.circle(screen, p['color'], (int(p['x']), int(p['y'])), p['size'])
    
    # Draw car or explosion
    if car_1.explosion == True:
        screen.blit(t_blast, (car_1_x_int, car_1_y_int))
    else:
        screen.blit(car_1.sprite, car_1.rect)
    
    pygame.display.update()
    clock.tick(60)

exit()